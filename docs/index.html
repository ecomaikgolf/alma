<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>alma: alma</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">alma
   </div>
   <div id="projectbrief">toy kernel written in C/C++ for x86_64 machines with UEFI</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">alma </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p  align="center"><a class="anchor" id="md_README"></a> </p>
<p ><img src="https://ls.ecomaikgolf.com/alma/img/logo3.png" alt="" width="300" height="100" class="inline"/> </p>
<p  align="center"></p>
<p ><em>alma is a toy kernel written in C/C++ for x86_64 machines with the mere purpose of learning OS development</em> </p>
<h1><a class="anchor" id="autotoc_md0"></a>
alma</h1>
<blockquote class="doxtable">
<p >&zwj;6. f. Sustancia o parte principal de cualquier cosa. </p>
</blockquote>
<p ><img src="https://ls.ecomaikgolf.com/alma/img/screen.png" alt="" width="800" height="500" class="inline"/> </p>
<h2><a class="anchor" id="autotoc_md1"></a>
Features</h2>
<ul>
<li>project<ul>
<li>configuration<ul>
<li>cmake</li>
<li><code>cmake -B build</code></li>
</ul>
</li>
<li>build<ul>
<li><code>make -C build</code></li>
<li>out of source builds</li>
</ul>
</li>
<li>run &amp; debug<ul>
<li><code>make -C build run</code></li>
<li><code>make -C build debug</code></li>
</ul>
</li>
<li>documentation<ul>
<li>inner workings (bachelor's final project)</li>
<li>code (doxygen + comments)</li>
</ul>
</li>
<li>build releases<ul>
<li><a href="https://ls.ecomaikgolf.com/alma/builds/">https://ls.ecomaikgolf.com/alma/builds/</a></li>
</ul>
</li>
<li>git<ul>
<li>more or less clean management</li>
</ul>
</li>
<li>toolchain<ul>
<li>compilation from sources<ul>
<li>binutils<ul>
<li>x86_64-elf target</li>
</ul>
</li>
<li>gcc<ul>
<li>disable red zone patch</li>
<li>only c/c++ compiler</li>
<li>disable std/runtime things</li>
<li>x86_64-elf target</li>
</ul>
</li>
<li>edk2<ul>
<li>release build</li>
</ul>
</li>
<li>posix-uefi<ul>
<li>independent from posix-uefi Makefile</li>
</ul>
</li>
</ul>
</li>
<li>easy toolchain instalation<ul>
<li>1: dependencies &amp; <code>make -C toolchain</code></li>
<li>2: preconfigured alma build VM</li>
</ul>
</li>
<li>git submodules (easy toolchain updating)</li>
</ul>
</li>
</ul>
</li>
<li>uefi shell<ul>
<li>bootloader run script (deprecated)</li>
</ul>
</li>
<li>bootloader<ul>
<li>C + posix-uefi<ul>
<li>commented code (doxygen)</li>
<li>compilation independent from posix-uefi's makefile (cmake)</li>
</ul>
</li>
<li>loads kernel</li>
<li>parses and verifies (some) ELF headers</li>
<li>graphics output protocol from UEFI</li>
<li>framebuffer</li>
<li>uefi memory map</li>
<li>PSF1 fonts</li>
<li>obtain the RSDP (Root System Descriptor Pointer)</li>
<li>manually call kernel .ctors functions</li>
<li>exit UEFI boot services</li>
<li>jumps to kernel</li>
</ul>
</li>
<li>kernel<ul>
<li>C++/NASM-ASM<ul>
<li>commented code (doxygen)</li>
<li>structured (folders and namespaces)</li>
</ul>
</li>
<li>Call C++ global constructors before starting the kernel</li>
<li>screen/tty<ul>
<li>print pixels</li>
<li>print letters with a PSF1 font</li>
<li>colors</li>
<li>printf</li>
</ul>
</li>
<li>pagination<ul>
<li>page frame allocator<ul>
<li>request, reserve, lock... pages (bitset)</li>
</ul>
</li>
<li>virtual memory<ul>
<li>CPU's MMU virt-phys translation</li>
<li>512-ary tree (4 levels)</li>
</ul>
</li>
</ul>
</li>
<li>segmentation<ul>
<li>dummy global descriptor table (I use paging)</li>
</ul>
</li>
<li>interrupts<ul>
<li>interrupt descriptor table</li>
<li>register (vector, interrupt routine)</li>
<li>call interrupt routines on interrupts</li>
</ul>
</li>
<li>keyboard<ul>
<li>PS2 keyboard support</li>
<li>capital letters</li>
<li>functional Lshift, Lalt, Lctrl</li>
<li>only 8byte chars</li>
</ul>
</li>
<li>acpi<ul>
<li>get the RSDP from UEFI</li>
<li>get/query acpi tables</li>
<li>get the MCFG</li>
</ul>
</li>
<li>pci/pcie<ul>
<li>enumerate dev/bus/func (iterating)</li>
<li>Access PCIe Enhanced Configuration Access Mechanism (ECAM)</li>
</ul>
</li>
<li>networking<ul>
<li>emulate Realtek RTL8139 network chip (qemu)</li>
<li>get the MAC through MMIO</li>
</ul>
</li>
<li>dynamic memory<ul>
<li>simple memory allocator</li>
<li><code>malloc()</code>, <code>free()</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md2"></a>
Run</h2>
<p >0. Install dependencies (listed below)</p><ol type="1">
<li>Find build to test <a href="https://ls.ecomaikgolf.com/alma/builds/">https://ls.ecomaikgolf.com/alma/builds/</a></li>
<li>Download a build with wget:</li>
</ol>
<div class="fragment"><div class="line">wget https://ls.ecomaikgolf.com/alma/builds/20211012-e906c4c.tar.gz # &lt;-- Change build version!</div>
<div class="line">tar xf 20211012-e906c4c.tar.gz</div>
<div class="line">cd 20211012-e906c4c</div>
</div><!-- fragment --><ol type="1">
<li>Download precompiled edk2 Ovmf UEFI</li>
</ol>
<div class="fragment"><div class="line">wget https://ls.ecomaikgolf.com/alma/builds/bios.bin</div>
</div><!-- fragment --><ol type="1">
<li>Run</li>
</ol>
<div class="fragment"><div class="line">make</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md3"></a>
Run Dependencies</h3>
<ul>
<li><code>qemu-system-x86</code></li>
</ul>
<p >Ubuntu: <code>apt install qemu-system-x86 qemu-system-gui</code></p>
<p >Arch-Linux: <code>pacman -S qemu qemu-arch-extra</code></p>
<h2><a class="anchor" id="autotoc_md4"></a>
Build</h2>
<h3><a class="anchor" id="autotoc_md5"></a>
Virtual Machine</h3>
<p >Get the "Alma Build VM" (.ova 5.9G), a Xubuntu 20.04 virtualbox VM ready to compile.</p>
<p ><b>Download (@gcloud.ua.es):</b> <a href="https://drive.google.com/file/d/1neuuBo7Ja4Czmwre1SWPkwGSF8MV98s3/view?usp=sharing">https://drive.google.com/file/d/1neuuBo7Ja4Czmwre1SWPkwGSF8MV98s3/view?usp=sharing</a></p>
<p ><img src="https://ls.ecomaikgolf.com/alma/img/alma-build-vm.png" alt="" width="800" height="400" class="inline"/> </p>
<p >Features:</p><ul>
<li>already compiled toolchain</li>
<li>systemwide ccache</li>
<li>preconfigured "neutral" IDE (vscodium)</li>
<li>one click functionalities<ul>
<li>compile</li>
<li>run</li>
<li>update</li>
<li>clean</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md6"></a>
Manual</h3>
<p >Tested on <code>Ubuntu 20.04</code></p>
<ol type="1">
<li>Install dependencies (listed below)</li>
<li><code>make -C toolchain/</code></li>
<li><code>cmake -DCMAKE_BUILD_TYPE=Release -B build; cmake --build build</code></li>
<li><code>make -C qemu-fs</code></li>
</ol>
<h4><a class="anchor" id="autotoc_md7"></a>
Build Dependencies</h4>
<ul>
<li>nasm</li>
<li>iasl</li>
<li>cmake</li>
<li>qemu-system-x86</li>
<li>qemu-system-gui</li>
<li>uuid-dev</li>
<li>python</li>
<li>python3-distutils</li>
<li>texinfo</li>
<li>bison</li>
<li>flex</li>
<li>mtools</li>
</ul>
<p >Remember to have: <code>make</code> <code>git</code> <code>bash</code> <code>build-essential</code></p>
<p >Ubuntu 20.04 (and similars) one-command dependencies installer:</p>
<div class="fragment"><div class="line">apt install nasm iasl cmake make qemu-system-x86 qemu-system-gui git uuid-dev python python3-distutils bash texinfo bison flex build-essential mtools</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
Bugs</h2>
<p >Explain them to me please: <code>me@ecomaikgolf.com</code></p>
<h2><a class="anchor" id="autotoc_md9"></a>
FAQ</h2>
<blockquote class="doxtable">
<p >&zwj;Q: Muh tons of dependencies</p>
<p >A: I have to compile binutils, gdb, edk2 and posix-uefi from source </p>
</blockquote>
<blockquote class="doxtable">
<p >&zwj;Q: 5.9GB VM</p>
<p >A: I can't do more. Xubuntu + "zeroed" free memory before exporting so it can compress it. </p>
</blockquote>
<blockquote class="doxtable">
<p >&zwj;Q: Frequently asked questions?</p>
<p >A: More like preanswered questions </p>
</blockquote>
<h2><a class="anchor" id="autotoc_md10"></a>
Bibliography</h2>
<ul>
<li><a href="https://wiki.osdev.org/Main_Page">https://wiki.osdev.org/Main_Page</a></li>
<li><a href="https://youtu.be/NpcGMuI7hxk">https://youtu.be/NpcGMuI7hxk</a></li>
<li><a href="https://0xax.gitbooks.io/linux-insides/content/Interrupts/">https://0xax.gitbooks.io/linux-insides/content/Interrupts/</a></li>
<li><a href="https://youtu.be/mpPbKEeWIHU">https://youtu.be/mpPbKEeWIHU</a></li>
<li><a href="https://www.iaik.tugraz.at/teaching/materials/os/tutorials/paging-on-intel-x86-64/">https://www.iaik.tugraz.at/teaching/materials/os/tutorials/paging-on-intel-x86-64/</a></li>
<li><a href="https://git.musl-libc.org/cgit/musl/tree">https://git.musl-libc.org/cgit/musl/tree</a></li>
<li><a href="https://maskray.me/blog/2021-11-07-init-ctors-init-array">https://maskray.me/blog/2021-11-07-init-ctors-init-array</a></li>
<li><a href="https://blog.llandsmeer.com/tech/2019/07/21/uefi-x64-userland.html">https://blog.llandsmeer.com/tech/2019/07/21/uefi-x64-userland.html</a></li>
</ul>
<p ><em>The list is longer but I can't put each site where I read something. This list is a good place to start</em></p>
<h2><a class="anchor" id="autotoc_md11"></a>
Author</h2>
<p >Ernesto Martínez García</p><ul>
<li><a href="#" onclick="location.href='mai'+'lto:'+'me@'+'ec'+'oma'+'ik'+'gol'+'f.'+'com'; return false;">me@ec<span class="obfuscator">.nosp@m.</span>omai<span class="obfuscator">.nosp@m.</span>kgolf<span class="obfuscator">.nosp@m.</span>.com</a> _(C79F 01CE 017F 57A4 FBBB 4E22 33DD FB0A EB94 20CB)_</li>
<li><a href="#" onclick="location.href='mai'+'lto:'+'emg'+'16'+'2@a'+'lu'+'.ua'+'.e'+'s'; return false;">emg16<span class="obfuscator">.nosp@m.</span>2@al<span class="obfuscator">.nosp@m.</span>u.ua.<span class="obfuscator">.nosp@m.</span>es</a> [<a href="https://github.com/leereilly/swot/blob/master/lib/domains/es/ua.txt">verify</a>]</li>
<li><a href="https://ecomaikgolf.com/">https://ecomaikgolf.com/</a></li>
<li><a href="https://twitter.com/ecomaikgolf">https://twitter.com/ecomaikgolf</a> </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
